<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST SCANNER // PERPLEXITY OPS</title>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-red: #ff003c;
            --dark-bg: #020204;
            --terminal-bg: #0a0a0f;
            --font-stack: 'Courier New', Courier, monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--dark-bg);
            color: var(--neon-blue);
            font-family: var(--font-stack);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* CRT Overlay */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        h1 {
            text-shadow: 0 0 10px var(--neon-blue);
            text-transform: uppercase;
            letter-spacing: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--neon-blue);
            padding-bottom: 10px;
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            position: relative;
            z-index: 1;
        }

        .control-panel {
            background: var(--terminal-bg);
            border: 1px solid var(--neon-blue);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--neon-purple);
        }

        input[type="text"], input[type="password"] {
            background: #000;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 10px;
            font-family: var(--font-stack);
            font-size: 1rem;
            outline: none;
        }

        input:focus { box-shadow: 0 0 15px var(--neon-blue); }

        .btn {
            background: #000;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 12px 24px;
            font-family: var(--font-stack);
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 20px var(--neon-blue);
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #console-output {
            display: none;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 50px;
        }

        .threat-card {
            border-left: 4px solid var(--neon-purple);
            background: rgba(10, 10, 20, 0.8);
            padding: 15px;
            border-top: 1px solid #111;
        }

        .threat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .threat-name { font-size: 1.2rem; font-weight: bold; color: white; }
        .threat-type { font-size: 0.8rem; background: var(--neon-purple); color: white; padding: 2px 6px; }

        .threat-reason {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .strategy-box {
            border-top: 1px dashed var(--neon-blue);
            padding-top: 10px;
        }

        .counter-btn {
            background: transparent;
            border: 1px solid var(--neon-purple);
            color: var(--neon-purple);
            padding: 5px 10px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-size: 0.8rem;
        }

        .counter-btn:hover { background: var(--neon-purple); color: white; }

        .strategy-result {
            margin-top: 10px;
            color: var(--neon-blue);
            font-style: italic;
            display: none;
        }

        .error-msg {
            color: var(--neon-red);
            border: 1px solid var(--neon-red);
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .loading { display: none; text-align: center; margin-top: 20px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

    </style>
</head>
<body>

    <h1>Ghost Competitor Scanner</h1>

    <div class="container">
        <div class="control-panel">
            <div class="input-group">
                <label for="apiKey">:: PERPLEXITY_API_KEY (pplx-...) ::</label>
                <input type="password" id="apiKey" placeholder="Starts with pplx-..." autocomplete="off">
            </div>
            <div class="input-group">
                <label for="keyword">:: TARGET_KEYWORD ::</label>
                <input type="text" id="keyword" placeholder="e.g. 'Best productivity app for developers'">
            </div>
            <button class="btn" id="scanBtn">INITIATE SONAR SCAN</button>
            <div class="loading" id="loadingIndicator">ACCESSING REAL-TIME WEB INDEX...</div>
            <div class="error-msg" id="errorMsg"></div>
        </div>

        <div id="console-output"></div>
    </div>

    <script>
        const scanBtn = document.getElementById('scanBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const keywordInput = document.getElementById('keyword');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMsg = document.getElementById('errorMsg');
        const consoleOutput = document.getElementById('console-output');

        scanBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            const keyword = keywordInput.value.trim();

            errorMsg.style.display = 'none';
            consoleOutput.innerHTML = '';
            
            if (!apiKey || !keyword) {
                showError('ERROR: MISSING CREDENTIALS.');
                return;
            }

            setLoading(true);

            try {
                // Perplexity System Prompt
                const systemPrompt = `
                    You are a Competitive Intelligence Engine. 
                    Your goal is to find "Invisible Competitors" for the user's keyword.
                    These are NOT the big brands. These are Reddit threads, Indie Hackers projects, Substack newsletters, or niche forums that rank high in AI answers.
                    
                    Return STRICT JSON. No markdown. Structure:
                    {
                      "sources": [
                        { "name": "Name", "url": "URL", "why_trusted": "Why AI engines cite this" }
                      ]
                    }
                `;

                const userPrompt = `Find 3 ghost competitors for: "${keyword}". Prioritize sources with high community engagement.`;

                // Call Perplexity API
                const data = await callPerplexity(apiKey, systemPrompt, userPrompt);
                
                // Parse JSON from the response text
                let rawText = data.choices[0].message.content;
                
                // Clean formatting (Perplexity is usually clean, but just in case)
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const firstBrace = rawText.indexOf('{');
                const lastBrace = rawText.lastIndexOf('}');
                if(firstBrace !== -1 && lastBrace !== -1) {
                    rawText = rawText.substring(firstBrace, lastBrace + 1);
                }

                const parsed = JSON.parse(rawText);
                renderThreats(parsed.sources, apiKey);

            } catch (err) {
                console.error(err);
                showError(`CONNECTION SEVERED: ${err.message}`);
            } finally {
                setLoading(false);
            }
        });

        // --- PERPLEXITY API HANDLER ---
        async function callPerplexity(key, sysMsg, userMsg) {
            const url = 'https://api.perplexity.ai/chat/completions';
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    // The "Online" model is crucial for real-time web results
                    model: 'llama-3.1-sonar-large-128k-online', 
                    messages: [
                        { role: 'system', content: sysMsg },
                        { role: 'user', content: userMsg }
                    ],
                    temperature: 0.2 // Low temp for more factual JSON
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || `Status ${response.status}`);
            }

            return await response.json();
        }

        function renderThreats(sources, apiKey) {
            consoleOutput.style.display = 'flex';
            
            if(!sources || sources.length === 0) {
                consoleOutput.innerHTML = '<div style="text-align:center">NO SIGNALS DETECTED.</div>';
                return;
            }

            sources.forEach((source, index) => {
                const card = document.createElement('div');
                card.className = 'threat-card';
                card.innerHTML = `
                    <div class="threat-header">
                        <span class="threat-name">${source.name}</span>
                        <span class="threat-type">LIVE SIGNAL</span>
                    </div>
                    <div class="threat-reason">
                        <strong>VECTOR:</strong> ${source.why_trusted}<br>
                        <small style="opacity:0.7; color:var(--neon-blue)">${source.url}</small>
                    </div>
                    <div class="strategy-box">
                        <button class="counter-btn" id="btn-${index}">GENERATE COUNTER-OP</button>
                        <div class="strategy-result" id="res-${index}"></div>
                    </div>
                `;
                consoleOutput.appendChild(card);

                // Counter-Strategy (Uses Perplexity again for live tactical advice)
                document.getElementById(`btn-${index}`).addEventListener('click', async (e) => {
                    const btn = e.target;
                    const resDiv = document.getElementById(`res-${index}`);
                    
                    btn.textContent = 'ANALYZING...';
                    btn.disabled = true;

                    try {
                        const stratPrompt = `
                            Target: "${source.name}" (${source.url}).
                            Context: They are winning on the keyword "${document.getElementById('keyword').value}".
                            Task: Give me 1 specific, actionable growth hack to outrank or co-opt them.
                        `;
                        
                        const data = await callPerplexity(apiKey, "You are a growth hacking expert. Be concise.", stratPrompt);
                        const strategy = data.choices[0].message.content;

                        resDiv.style.display = 'block';
                        resDiv.textContent = `> ${strategy}`;
                        btn.textContent = 'OP EXECUTED';
                        
                    } catch (err) {
                        btn.textContent = 'RETRY';
                        btn.disabled = false;
                        alert('Strategy computation failed.');
                    }
                });
            });
        }

        function setLoading(state) {
            loadingIndicator.style.display = state ? 'block' : 'none';
            scanBtn.disabled = state;
            scanBtn.style.opacity = state ? '0.5' : '1';
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
        }
    </script>
</body>
</html>
